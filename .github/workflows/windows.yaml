name: Build and Release Windows Artifact

on:
  push:
    branches: [ main ]
  # Optional: trigger on version tags
  # tags:
  #   - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Generate version
      id: version
      shell: pwsh
      run: |
        $SHORT_SHA = $env:GITHUB_SHA.Substring(0, 7)
        $VERSION = "$SHORT_SHA"
        Write-Output "VERSION=$VERSION"
        Write-Output "version=$VERSION" | Out-File -FilePath $env:GITHUB_ENV -Append
        Write-Host "Generated version: $VERSION"
        
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'
        
    - name: Install Python dependencies
      shell: pwsh
      run: |
        python -m pip install --upgrade pip
        if (Test-Path "requirements.txt") {
          pip install -r requirements.txt
        } else {
          Write-Host "requirements.txt not found, skipping dependency installation"
        }
        
    - name: Build Windows Artifact
      shell: pwsh
      run: |
        python setup.py build
        
    - name: Verify build output
      shell: pwsh
      run: |
        Write-Host "Checking build output..."
        if (Test-Path "dist") {
          Write-Host "Dist folder contents:"
          Get-ChildItem -Path dist -Recurse | Format-Table Name, Length, LastWriteTime
        } else {
          Write-Host "ERROR: dist folder not found!"
          Write-Host "Current directory contents:"
          Get-ChildItem
          exit 1
        }
        
    - name: Create Windows ZIP archive
      shell: pwsh
      run: |
        $version = $env:version
        $zipName = "XDash.zip"
        
        Write-Host "Creating $zipName..."
        
        # Create ZIP archive using PowerShell's Compress-Archive
        if (Test-Path "dist") {
          # Compress the entire dist folder
          Compress-Archive -Path "dist\*" -DestinationPath $zipName -Force
          
          # Verify the zip was created
          if (Test-Path $zipName) {
            $zipSize = (Get-Item $zipName).Length / 1MB
            Write-Host "Successfully created $zipName ($([math]::Round($zipSize, 2)) MB)"
          } else {
            Write-Host "ERROR: Failed to create zip file"
            exit 1
          }
        } else {
          Write-Host "ERROR: dist folder not found!"
          exit 1
        }
        
    - name: Show created artifacts
      shell: pwsh
      run: |
        Write-Host "Created artifacts:"
        Get-ChildItem *.zip | Format-Table Name, Length, LastWriteTime
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.version }}
        name: "XDash Release [${{ env.version }}]"
        body: |
          # XDash Release [${{ env.version }}]
          
          **Version:** ${{ env.version }}
          **Commit:** [${{ github.sha }}](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          **Build Date:** ${{ github.event.head_commit.timestamp }}
          
          ### Download
          ðŸ“¦ **[XDash.zip](${{ github.server_url }}/${{ github.repository }}/releases/download/${{ env.version }}/XDash.zip)** - XDash Windows Artifact
          
          ### Installation Instructions
          1. **Download** the zip file above
          2. **Extract** to your desired location
          3. **Run** the application executable
          
          ### Recent Changes
          ${{ github.event.head_commit.message }}
          
          ---
          *Automatically generated by GitHub Actions*
        draft: false
        prerelease: false
        generate_release_notes: false
        files: |
          XDash.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}